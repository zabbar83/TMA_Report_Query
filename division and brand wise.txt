WITH Present as(-- division wise presentActive count start
select  division_id,
        division_name,
        sum(tms)tms,
        sum(tmr)tmr
        
From 
(SELECT division_id,
        division_name,
        territory_id,
        territory_name,
        NVL(SUM(tmsPresentCount),0) tms,
        NVL(SUM(tmrPresentCount),0) tmr    
FROM    (
SELECT  
        d.id division_id,
        d.teritory_name division_name,
        t.teritory_name territory_name,
        t.id territory_id,
        '0' tmoPresentCount,
        sum(CASE WHEN r.role = 'TMS' THEN 1 ELSE 0 END) tmsPresentCount,
        sum(CASE WHEN r.role = 'TMR' THEN 1 ELSE 0 END) tmrPresentCount
FROM    bruser_teritory but
JOIN    bruser_attendance bua
        ON but.bruser_id = bua.br_user_user_id
        AND to_date(TO_CHAR(bua.attendance_date, 'dd-mm-yyyy'), 'dd-mm-yyyy') BETWEEN to_date(:fromDate, 'dd-mm-yyyy')  AND to_date(:toDate, 'dd-mm-yyyy')
        AND to_date(bua.attendance_date, 'dd-mm-yy') BETWEEN to_date(but.ed, 'dd-mm-yy') AND to_date(but.td, 'dd-mm-yy')
JOIN    teritory t
        ON but.teritory_id = t.id
JOIN    teritory d
        ON t.parent_id = d.id
JOIN    bruser_roles bur
        ON bua.br_user_user_id = bur.bruser_user_id
JOIN    role r
        ON bur.roles_id = r.id
where   d.id like '%' || :divisionId || '%'
GROUP   BY d.id,d.teritory_name,t.teritory_name,t.id, r.role)
GROUP   BY division_id,division_name,territory_id, territory_name)
GROUP   BY division_id,division_name
),
target as
(
--target
Select  division_id,
        division_name,
        sum(mariseSalesTarget) mariseSalesTarget,
        sum(sunmoonSalesTarget) sunmoonSalesTarget,
        sum(rallySalesTarget) rallySalesTarget,
        sum(totalSalesTarget) totalSalesTarget,
        sum(mariseSamplingAll) mariseSamplingAll,
        sum(sunmoonSamplingAll) sunmoonSamplingAll,
        sum(rallySamplingAll) rallySamplingAll,
        sum(totalSamplingAll) totalSamplingAll,
        sum(mariseVaoAll) mariseVaoAll,
        sum(sunmoonVaoAll) sunmoonVaoAll,
        sum(rallyVaoAll) rallyVaoAll,
        sum(totalVaoAll) totalVaoAll,
        sum(mariseBundleAll) mariseBundleAll,
        sum(sunmoonBundleAll) sunmoonBundleAll,
        sum(rallyBundleAll) rallyBundleAll,
        sum(totalBundleAll) totalBundleAll,
        sum(marisePackAll) marisePackAll,
        sum(sunmoonPackAll) sunmoonPackAll,
        sum(rallyPackAll) rallyPackAll,
        sum(totalPackAll) totalPackAll  
From 
(SELECT  d.id division_id,d.teritory_name division_name,t.id territory_id,t.teritory_name territory_name,
        sum(case when ab.product_id in(4,23) THEN ab.CONTACT_TARGET else 0 end) mariseSalesTarget,
        sum(case when ab.product_id in(16) THEN ab.CONTACT_TARGET else 0 end) sunmoonSalesTarget,
        sum(case when ab.product_id in(1) THEN ab.CONTACT_TARGET else 0 end) rallySalesTarget,
        sum(case when ab.product_id in(1,4,16,23) THEN ab.CONTACT_TARGET else 0 end) totalSalesTarget,
        NVL(sum(case when ab.product_id in(4,23) THEN ab.FREE_SAMPLING else 0 end),0) mariseSamplingAll,
        NVL(sum(case when ab.product_id in(16) THEN ab.FREE_SAMPLING else 0 end),0)sunmoonSamplingAll,
        NVL(sum(case when ab.product_id in(1) THEN ab.FREE_SAMPLING else 0 end),0)rallySamplingAll,
        NVL(sum(case when ab.product_id in(1,4,16,23) THEN ab.FREE_SAMPLING else 0 end),0)totalSamplingAll,
        NVL(sum(case when ab.product_id in(4,23) THEN ab.VAO_SALES_TARGET else 0 end),0) mariseVaoAll,
        NVL(sum(case when ab.product_id in(16) THEN ab.VAO_SALES_TARGET else 0 end),0)sunmoonVaoAll,
        NVL(sum(case when ab.product_id in(1) THEN ab.VAO_SALES_TARGET else 0 end),0)rallyVaoAll,
        NVL(sum(case when ab.product_id in(1,4,16,23) THEN ab.VAO_SALES_TARGET else 0 end),0)totalVaoAll,
        NVL(sum(case when ab.product_id in(4,23) THEN ab.BUNDLE_SALES_TARGET else 0 end),0) mariseBundleAll,
        NVL(sum(case when ab.product_id in(16) THEN ab.BUNDLE_SALES_TARGET else 0 end),0)sunmoonBundleAll,
        NVL(sum(case when ab.product_id in(1) THEN ab.BUNDLE_SALES_TARGET else 0 end),0)rallyBundleAll,
        NVL(sum(case when ab.product_id in(1,4,16,23) THEN ab.BUNDLE_SALES_TARGET else 0 end),0)totalBundleAll,
        NVL(sum(case when ab.product_id in(4,23) THEN ab.PACKET_SALES_TARGET else 0 end),0) marisePackAll,
        NVL(sum(case when ab.product_id in(16) THEN ab.PACKET_SALES_TARGET else 0 end),0)sunmoonPackAll,
        NVL(sum(case when ab.product_id in(1) THEN ab.PACKET_SALES_TARGET else 0 end),0)rallyPackAll,
        NVL(sum(case when ab.product_id in(1,4,16,23) THEN ab.PACKET_SALES_TARGET else 0 end),0)totalPackAll
FROM    ASSIGN_BRAND ab
JOIN    BRUSER_ATTENDANCE ba 
        ON ba.BR_TEAM_TEAM_ID = ab.BR_TEAM_ID 
        AND ab.TARGET_DATE = ba.ATTENDANCE_DATE 
JOIN    bruser_teritory but 
        ON ba.br_user_user_id = but.BRUSER_ID
        AND ba.attendance_date between but.ed and but.td
JOIN    bruser_roles bur ON ba.br_user_user_id = bur.bruser_user_id
JOIN    TERITORY t 
        ON t.ID = ab.TERITORY_ID 
JOIN    TERITORY d 
        ON t.PARENT_ID = d.ID
WHERE   to_date(TO_CHAR(ba.ATTENDANCE_DATE_TIME, 'dd-mm-yyyy'), 'dd-mm-yyyy') BETWEEN to_date(:fromDate, 'dd-mm-yyyy')  AND to_date(:toDate, 'dd-mm-yyyy')
and     to_date(TO_CHAR(ab.target_date, 'dd-mm-yyyy'), 'dd-mm-yyyy') BETWEEN to_date(:fromDate, 'dd-mm-yyyy')  AND to_date(:toDate, 'dd-mm-yyyy')
and     bur.roles_id = 12
AND     d.ID LIKE '%'||:divisionId ||'%'
GROUP   BY d.id,d.teritory_name,t.id,t.teritory_name)
Group   by division_id,division_name
),

allocation as
(
--Allocation
Select  division_id,
        division_name,
        sum(tmoAllocation)tmoAllocation,
        sum(tmsAllocation)tmsAllocation,
        sum(tmrAllocation)tmrAllocation
From (SELECT  division_id,
        division_name,
        TERRITORY_ID,
        teritory_name,
        sum(tmoAllocation) tmoAllocation,
        sum(tmsAllocation) tmsAllocation,
        sum(tmrAllocation) tmrAllocation
From
(   SELECT  d.id division_id,
            d.teritory_name division_name,
            pap.TERRITORY_ID,
            t.teritory_name,
    TO_CHAR(apa.TARGET_DATE , 'dd-mm-yyyy'),
    sum(CASE WHEN pa.ROLE_ID = 10 THEN pa.ALLOCATION END) tmoAllocation,
    sum(CASE WHEN pa.ROLE_ID = 11 THEN pa.ALLOCATION END) tmsAllocation,
    sum(CASE WHEN pa.ROLE_ID = 12 THEN pa.ALLOCATION END) tmrAllocation
    FROM ASSIGN_POSITION_ALLOCATION apa 
    JOIN POSITION_ALLOCATION_POLICY pap ON apa.POSITION_ALLOCATION_POLICY_ID = pap.ID  
    JOIN POSITION_ALLOCATION pa ON pa.POSITION_ALLOCATION_POLICY_ID = pap.ID
    JOIN TERITORY t ON pap.territory_id=t.id
    JOIN TERITORY d ON t.parent_id=d.id
    WHERE to_date(TO_CHAR(apa.TARGET_DATE , 'dd-mm-yyyy'), 'dd-mm-yyyy') 
    BETWEEN to_date(:fromDate, 'dd-mm-yyyy') AND to_date(:toDate, 'dd-mm-yyyy')
    and d.id like '%' || :divisionId || '%'
    GROUP BY d.id,d.teritory_name,pap.TERRITORY_ID,t.teritory_name, TO_CHAR(apa.TARGET_DATE , 'dd-mm-yyyy'))
    GROUP BY division_id,division_name,TERRITORY_ID,TERITORY_NAME)
    Group By division_id,division_name
),
activity as
(
--Activity
Select  division_id,
        division_name,
        sum(teamCount)teamCount,
        sum(tmrActiveCount) tmrActiveCount,
        sum(total_rally_activity) total_rally_activity,
        sum(total_marise_activity) total_marise_activity,
        sum(total_sunmoon_activity) total_sunmoon_activity,
        sum(total_activity) total_activity,
        sum(rallyTotalSampling) rallyTotalSampling,
        sum(MariseTotalSampling) MariseTotalSampling,
        sum(sunmoonTotalSampling) sunmoonTotalSampling,
        sum(totalSampling) totalSampling,
        sum(rallyTotalVao) rallyTotalVao,
        sum(MariseTotalVao) MariseTotalVao,
        sum(sunmoonTotalVao) sunmoonTotalVao,
        sum(totalVao) totalVao,
        sum(rallyTotalBundle) rallyTotalBundle,
        sum(mariseTotalBundle) mariseTotalBundle,
        sum(sunmoonTotalBundle) sunmoonTotalBundle,
        sum(totalBundle) totalBundle,
        sum(rallyTotalPacket) rallyTotalPacket,
        sum(MariseTotalPacket) MariseTotalPacket,
        sum(sunmoonTotalPacket) sunmoonTotalPacket,
        sum(totalPacket) totalPacket
From (select  vter.division_id,
        vter.division_name,
        vter.teritory_id  as territory_Id,
        vter.teritory_name territory_Name,
        count(distinct bract.BR_TEAM_TEAM_ID) teamCount,
        count(distinct bract.BR_user_ID) tmrActiveCount,
        sum(case
            when (bract.contact_module is not null and
            (bract.contact_module = 'RALLY' or bract.contact_module = 'RALLY_RACER'))
            OR bract.offered_brand in (1, 2, 11, 12, 13, 14) 
        then 1 else 0 end)    total_rally_activity,
        sum(case when (bract.contact_module is not null 
            and bract.contact_module IN ('MARISE','MBD_REGULAR','MBD_MAGIC'))
            or bract.offered_brand in (4,5,22,23) 
        then 1 else 0 end) total_marise_activity,
        sum(case
        when (bract.contact_module is not null 
            and bract.contact_module = 'SUN_MOON') then 1
        else 0 end) total_sunmoon_activity,
            count(distinct bract.id) as total_activity,
            sum(CASE WHEN bract.OFFERED_BRAND IN (11, 12, 13, 14, 1, 2) and bract.SAMPLING_NO > 0 then 1 ELSE 0 END)  rallyTotalSampling,
            sum(case when bract.OFFERED_BRAND in (4, 5,22,23) and bract.SAMPLING_NO > 0 then 1 ELSE 0 END) MariseTotalSampling,
            sum(CASE WHEN bract.OFFERED_BRAND IN (16, 17, 18, 19, 20, 21) and bract.SAMPLING_NO > 0 then 1 ELSE 0 END) sunmoonTotalSampling,
            sum(CASE WHEN bract.OFFERED_BRAND IN (16, 17, 18, 19, 20, 21,11, 12, 13, 14, 1, 2,4, 5,22,23) and bract.SAMPLING_NO > 0 then 1 ELSE 0 END) totalSampling,
            sum(CASE WHEN bract.VAO_SALES_BRAND IN (11, 12, 13, 14, 1, 2) and bract.VAO_SALES_PACK > 0 then 1 ELSE 0 END)  rallyTotalVao,
            sum(case when bract.VAO_SALES_BRAND in (4, 5,22,23) and bract.VAO_SALES_PACK > 0 then 1 ELSE 0 END) MariseTotalVao,
            sum(CASE WHEN bract.VAO_SALES_BRAND IN (16, 17, 18, 19, 20, 21) and bract.VAO_SALES_PACK > 0 then 1 ELSE 0 END) sunmoonTotalVao,
            sum(CASE WHEN bract.OFFERED_BRAND IN (16, 17, 18, 19, 20, 21,11, 12, 13, 14, 1, 2,4, 5,22,23) and bract.VAO_SALES_PACK > 0 then 1 ELSE 0 END)totalVao,
            sum(CASE WHEN bract.BUNDLE_PRODUCT_ID IN (11, 12, 13, 14, 1, 2) and bract.BUNDLE_PRODUCT_QTY > 0 then 1 ELSE 0 END)  rallyTotalBundle,
            sum(case when bract.BUNDLE_PRODUCT_ID in (4, 5,22,23) and bract.BUNDLE_PRODUCT_QTY > 0 then 1 ELSE 0 END) mariseTotalBundle,
            sum(CASE WHEN bract.BUNDLE_PRODUCT_ID IN (16, 17, 18, 19, 20, 21) and bract.BUNDLE_PRODUCT_QTY > 0 then 1 ELSE 0 END) sunmoonTotalBundle,
            sum(CASE WHEN bract.OFFERED_BRAND IN (16, 17, 18, 19, 20, 21,11, 12, 13, 14, 1, 2,4, 5,22,23) and bract.BUNDLE_PRODUCT_QTY > 0 then 1 ELSE 0 END)totalBundle,
            sum(CASE WHEN bract.PACKET_SALES_BRAND IN (11, 12, 13, 14, 1, 2) and bract.SALES_PACK_QTY > 0 then 1 ELSE 0 END)  rallyTotalPacket,
            sum(case when bract.PACKET_SALES_BRAND in (4, 5,22,23) and bract.SALES_PACK_QTY > 0 then 1 ELSE 0 END) MariseTotalPacket,
            sum(CASE WHEN bract.PACKET_SALES_BRAND IN (16, 17, 18, 19, 20, 21) and bract.SALES_PACK_QTY > 0 then 1 ELSE 0 END) sunmoonTotalPacket,
            sum(CASE WHEN bract.OFFERED_BRAND IN (16, 17, 18, 19, 20, 21,11, 12, 13, 14, 1, 2,4, 5,22,23) and bract.SALES_PACK_QTY > 0 then 1 ELSE 0 END)totalPacket
            FROM v_teritory_all vter 
            LEFT JOIN (SELECT  * from (SELECT  * FROM BRACTIVITY UNION  SELECT * FROM BRACTIVITY_OLD) 
            WHERE to_date(TO_CHAR(target_date, 'dd-mm-yyyy'), 'dd-mm-yyyy') BETWEEN to_date(:fromDate, 'dd-mm-yyyy') AND to_date(:toDate, 'dd-mm-yyyy')
            ) bract on (bract.route_id = vter.route_id)
             WHERE  vter.DIVISION_ID LIKE '%' || :divisionId || '%'
             group BY vter.division_id,vter.division_name,vter.teritory_id, vter.teritory_name)
GROUP       BY division_id,division_name
)

Select  al.division_Id divisionId,
        al.division_name divisionNname,
        tmoAllocation approvedTmo,
        tmsAllocation approvedTms,
        tmrAllocation approvedTmr,
        a.teamCount numberOfTeam,
        0 "presentTmo",
        p.tms presentTms,
        p.tmr presentTmr,
        a.tmrActiveCount tmrActiveCount,
        mariseSalesTarget mariseConTarget,
        sunmoonSalesTarget sunmoonConTarget,
        rallySalesTarget   rallyConTarget,
        totalSalesTarget   totalConTarget,      
        mariseSamplingAll  mariseFreeAllotment,
        sunmoonSamplingAll  sunmoonFreeAllotment,
        rallySamplingAll  rallyFreeAllotment,
        totalSamplingAll  totalFreeAllotment,       
        mariseVaoAll   mariseVaoTarget,
        sunmoonVaoAll  sunmoonVaoTarget,
        rallyVaoAll    rallyVaoTarget,
        totalVaoAll    totalVaoTarget,       
        mariseBundleAll  mariseBundleTarget,
        sunmoonBundleAll sunmoonBundleTarget,
        rallyBundleAll   rallyBundleTarget,
        totalBundleAll   totalBundleTarget,
        marisePackAll    marisePacketTarget,
        sunmoonPackAll   sunmoonPacketTarget,
        rallyPackAll     rallyPacketTarget,
        totalPackAll     totalPacketTarget,
        total_rally_activity  rallyConContacted,
        total_marise_activity mariseConContacted,
        total_sunmoon_activity  sunmoonConContacted,
        total_activity   totalConContacted,
        rallyTotalSampling  rallyFreeUsed,
        mariseTotalSampling mariseFreeUsed,
        sunmoonTotalSampling sunmoonFreeUsed,
        totalSampling  totalFreeUsed,
        rallyTotalVao rallyVaoSales,
        MariseTotalVao mariseVaoSales,
        sunmoonTotalVao sunmoonVaoSales,
        totalVao totalVaoSales,
        rallyTotalBundle rallyBundleSales,
        mariseTotalBundle mariseBundleSales,
        sunmoonTotalBundle sunmoonBundleSales,
        totalBundle totalBundleSales,
        rallyTotalPacket rallyPacketSales,
        MariseTotalPacket marisePacketSales,
        sunmoonTotalPacket sunmoonPacketSales,
        totalPacket totalPacketSales
FROM    allocation al
JOIN 	  target t
        ON t.division_id=al.division_id
LEFT    JOIN present p
        ON al.division_id=p.division_id
LEFT    JOIN activity a
        ON al.division_id=a.division_id