select  bac.division_id divisionId,
        bac.division_name divisionName,
        bac.teritory_id teritoryId,
        bac.teritory_name teritoryName,
        count(crs.RETENTION_STATUS) firstRetained,
        count(case when crs.RETENTION_STATUS = 'Retained' then 1 else null end)  retainedTm,
        count(case when crs.RETENTION_STATUS = 'Initially_Retained' then 1 else null end)  initialRetTm,
        count(case when crs.RETENTION_STATUS = 'False_Claimed' then 1 else null end)  falseRetTm,
        count(case when crs.RETENTION_STATUS = 'N/A' then 1 else null end)  notFoundTm,
	count(ccvs.id) totalCheckedSm,
        count(case when ccvs.CHECKED_STATUS = 'True' then 1 else null end) trueSm,
        count(case when ccvs.CHECKED_STATUS = 'False' then 1 else null end) falseSm,
        count(case when ccvs.CHECKED_STATUS = 'Not Found' then 1 else null end) notFoundSm,
        count(case when ccvs.CHECKED_STATUS = 'Initially Retained' then 1 else null end) initialRetSm
From 
(SELECT
        id,
        added_date,
        CHECKED_DATE,
        RETENTION_STATUS,
        CHECKED_BY_BR_USER,
        CHECKED_BY_USER,
        BR_ACTIVITY_CONSUMER_ID,
        role,
        product_id
FROM
(
SELECT
        crcc.*,
        dsl.sl,
        ROW_NUMBER() OVER(PARTITION BY crcc.br_activity_consumer_id ORDER BY crcc.br_activity_consumer_id, dsl.sl) rnk
FROM
(
(
select
        crcc.id,
        to_char (cre.added_date,'dd-MON-YY')added_date,
        NVL(to_char (crcc.CHECKED_DATE,'dd-MON-YY'),'N/A')CHECKED_DATE,
        NVL(crcc.RETENTION_STATUS,'N/A')RETENTION_STATUS,
        NVL(to_char(crcc.CHECKED_BY_BR_USER),'N/A')CHECKED_BY_BR_USER,
        NVL(to_char(crcc.CHECKED_BY_USER),'N/A')CHECKED_BY_USER,
        cre.BR_ACTIVITY_CONSUMER_ID,
        NVL(ro.role,'N/A') role,
        cre.product_id
from    consumer_retention cre 
left    JOIN apptm.consumer_retention_cross_check crcc ON cre.BR_ACTIVITY_CONSUMER_ID=crcc.BR_ACTIVITY_CONSUMER_ID
left    JOIN apptm.bruser_roles brl ON crcc.CHECKED_BY_BR_USER=brl.bruser_user_id
left    JOIN apptm.role ro ON ro.id=brl.roles_id
where   cre.LAST_ACTIVITY_DATE between to_date(:fromDate,'dd-mm-yyyy') and to_date(:toDate,'dd-mm-yyyy')
)
union all
(
select
        crcc.id,
        to_char (cre.added_date,'dd-MON-YY')added_date,
        NVL(to_char (crcc.CHECKED_DATE,'dd-MON-YY'),'N/A') CHECKED_DATE,
        NVL(crcc.RETENTION_STATUS,'N/A') RETENTION_STATUS,
        NVL(to_char(crcc.CHECKED_BY_BR_USER),'N/A') CHECKED_BY_BR_USER,
        NVL(to_char(crcc.CHECKED_BY_USER),'N/A') CHECKED_BY_USER,
        cre.BR_ACTIVITY_CONSUMER_ID,
        NVL(r.role,'N/A') role,
        cre.product_id
FROM    consumer_retention cre
left    JOIN apptm.consumer_retention_cross_check crcc ON cre.BR_ACTIVITY_CONSUMER_ID=crcc.BR_ACTIVITY_CONSUMER_ID
left    JOIN apptm.users_roles ur ON crcc.CHECKED_BY_USER=ur.users_user_id
left    JOIN apptm.role r ON r.id=ur.roles_id
where   cre.LAST_ACTIVITY_DATE between to_date(:fromDate,'dd-mm-yyyy') and to_date(:toDate,'dd-mm-yyyy')
)
) crcc,
(
SELECT  1 sl, 'DIVISION_MANAGER' role FROM DUAL
UNION   ALL
SELECT  2 sl, 'TERRITORY_MANAGER' role FROM DUAL
UNION   ALL
SELECT  3 sl, 'TMS' role FROM DUAL
UNION   ALL
SELECT  4 sl, 'N/A' role FROM DUAL
) dsl
WHERE   crcc.role = dsl.role
)

where   rnk = 1
) crs 
JOIN
(SELECT  
        v.division_id ,
        v.division_name ,
        v.teritory_id ,
        v.teritory_name ,
        v.route_id,
        v.route_name ,
        cr.br_activity_consumer_id,
        p.product_name ,
        case when bu.user_name is not null then bu.user_name
             when u.user_id is not null then u.user_name 
        end user_name,
        case when brep.name is not null then brep.name
             when t.teritory_name is not null then t.teritory_name
             else 'N/A'
        end name,
        cr.added_date ,
        cr.LAST_ACTIVITY_DATE 
FROM    apptm.v_teritory_all v
JOIN    apptm.consumer_retention cr ON cr.route_id=v.route_id
left    JOIN apptm.bruser bu ON cr.BR_USER_USER_ID=bu.user_id
left    JOIN apptm.brand_representative brep ON bu.user_id=brep.BR_USER_USER_ID
JOIN    apptm.product p ON p.product_id=cr.product_id
left    JOIN apptm.users u on cr.user_id=u.user_id
left    JOIN apptm.teritory t ON u.teritory_id=t.id
where   cr.LAST_ACTIVITY_DATE between to_date(:fromDate,'dd-mm-yyyy') and to_date(:toDate,'dd-mm-yyyy')
AND     v.division_id like '%' || :divisionId || '%'
)bac
        ON crs.br_activity_consumer_id = bac.br_activity_consumer_id
LEFT    JOIN apptm.CROSS_CHECK_VERIFY_BY_SALES ccvs ON crs.id=ccvs.CON_RET_CROSS_CHE_ID
Group   by bac.division_id ,bac.division_name ,bac.teritory_id ,bac.teritory_name 
order   by bac.division_id ,bac.teritory_id