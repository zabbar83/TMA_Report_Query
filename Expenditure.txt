--[expenditure]
SELECT TERITORY_ID territoryId,
TERITORY_NAME territoryName,
BR_USER_ID brUserId,
USER_ID userId,
USER_NAME userName, 
	sum(NUMBEROFCONTACTED) contactQuantity,
    sum(BundlePack) pack10s,
    sum(VISITEDOUTLET) visitedOutlet,
    sum(mmtMATCHGIFTCONSUMER1) mmtmatchGiftConsumer, 
    sum(regularMATCHGIFTCONSUMER1) regularmatchGiftConsumer, 
	sum(MATCHGIFTRETAILER) matchGiftRetailer,
    sum(sampling1) sampling
FROM 
(WITH giftCount as
(SELECT BR_USER_USER_ID, to_char(bg.ADD_DATE_TIME,'dd-mm-yyyy') activityDate, count(1) giftCnt 
FROM appsm.BRGIFT bg  
WHERE bg.GIFT_ITEM_ID IN (11,14) AND GIFT_QUANTITY > 0
GROUP BY BR_USER_USER_ID, to_char(bg.ADD_DATE_TIME,'dd-mm-yyyy'))
SELECT vta.TERITORY_ID, vta.TERITORY_NAME, ba.BR_USER_ID, to_char(ba.TARGET_DATE,'dd-mm-yyyy') targetDate,
b.USER_NAME user_id, br.NAME user_name,  count(ba.ID) numberOfContacted, 
sum(ba.SALES_PACK_QTY) packetSales,
sum (case when ba.contact_module IN ('SUN_MOON') AND ba.BUNDLE_PRODUCT_QTY > 0 then 1
          when ba.contact_module IN ('MARISE') AND ba.SALES_PACK_QTY > 0 then 1
          when ba.contact_module IN ('MBD_REGULAR','MBD_MAGIC') AND ba.BUNDLE_PRODUCT_QTY > 0 then 1 else 0 end) BundlePack,
count(DISTINCT ba.OUTLET_ID) visitedOutlet,
sum(CASE WHEN ba.offered_brand in (22,23) and  ba.GIFT_ITEM_ID IN (11,14) AND ba.GIFT_QTY > 0 THEN 1 ELSE 0 end) mmtmatchGiftConsumer1,
sum(CASE WHEN  ba.offered_brand in (4,5) and  ba.GIFT_ITEM_ID IN (11,14) AND ba.GIFT_QTY > 0 THEN 1 
WHEN  ba.offered_brand in (16,17,18,19,20,21) and  ba.GIFT_ITEM_ID IN (11,14) AND ba.GIFT_QTY > 0 THEN 1 ELSE 0 end) RegularmatchGiftConsumer1,
nvl(bg.giftCnt,0) matchGiftRetailer,
sum (ba.sampling_no) sampling1
FROM appsm.BRACTIVITY ba 
JOIN appsm.V_TERITORY_ALL vta ON vta.ROUTE_ID = ba.ROUTE_ID 
JOIN appsm.BRUSER b ON b.USER_ID = ba.BR_USER_ID 
JOIN appsm.BRAND_REPRESENTATIVE br ON b.USER_ID = br.BR_USER_USER_ID
--left join brgame_activity bga on bga.br_activity_id=ba.id
LEFT JOIN giftCount bg ON bg.BR_USER_USER_ID = b.USER_ID AND to_char(ba.TARGET_DATE,'dd-mm-yyyy') = activityDate  --to_char(bg.activityDate,'dd-mm-yyyy') 
WHERE TO_DATE(to_char(ba.TARGET_DATE,'dd-mm-yyyy'),'dd-mm-yyyy') 
BETWEEN TO_DATE(:fromDate,'dd-mm-yyyy') AND TO_DATE(:toDate,'dd-mm-yyyy')
AND vta.DIVISION_ID LIKE '%'||:divisionId ||'%'
AND vta.TERITORY_ID LIKE '%'||:territoryId ||'%'
GROUP BY vta.TERITORY_ID, vta.TERITORY_NAME,b.USER_NAME,ba.BR_USER_ID, br.NAME, bg.giftCnt, to_char(ba.TARGET_DATE,'dd-mm-yyyy'))
GROUP BY TERITORY_ID,TERITORY_NAME,BR_USER_ID,USER_ID,USER_NAME
ORDER BY TERITORY_ID, BR_USER_ID