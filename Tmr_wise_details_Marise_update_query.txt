with present as
(select  id division_id, 
        division_name,
        territory_name,
        territory_id,
        tmrName,tmrId
        
from (SELECT d.id, 
        d.teritory_name division_name,
        t.teritory_name territory_name,
        t.id territory_id,
        r.teritory_name routeName,
        brep.name tmrName,
        bua.BR_USER_USER_ID tmrId
FROM    bruser_teritory but
JOIN    bruser_attendance bua
        ON but.bruser_id = bua.br_user_user_id
        AND to_date(TO_CHAR(bua.attendance_date, 'dd-mm-yyyy'), 'dd-mm-yyyy') BETWEEN to_date(:fromDate, 'dd-mm-yyyy')  AND to_date(:toDate, 'dd-mm-yyyy')
        AND to_date(bua.attendance_date, 'dd-mm-yy') BETWEEN to_date(but.ed, 'dd-mm-yy') AND to_date(but.td, 'dd-mm-yy')
JOIN    teritory t
        ON but.teritory_id = t.id
JOIN    teritory d
        ON t.parent_id = d.id
JOIN    teritory z
        ON z.parent_id = t.id
JOIN    teritory r
        ON r.parent_id = z.id
JOIN    bruser_roles bur
        ON bua.br_user_user_id = bur.bruser_user_id
JOIN    role r
        ON bur.roles_id = r.id
JOIN    brand_representative brep ON brep.BR_USER_USER_ID=bua.BR_USER_USER_ID
where   d.id like '%' || :divisionId || '%'
and     t.id like '%' || :territoryId || '%'
and     r.role = 'TMR'
GROUP   BY d.id,d.teritory_name,t.teritory_name,t.id,r.teritory_name,brep.name,bua.BR_USER_USER_ID, r.role
order   by bua.BR_USER_USER_ID)
group by id,division_name,territory_name,territory_id,tmrName,tmrId
),


target as
(
select  id division_id,territory_id, territory_name,br_user_user_id,
        max(mariseSalesTarget)mariseSalesTarget,
        max(msbRegularTarget)msbRegularTarget,
        max(mbdSalesTarget)mbdSalesTarget,
        max(mariseSamplingAll)mariseSamplingAll,
        max(msbRegularSamplingAll)msbRegularSamplingAll,
        max(mbdSamplingAll)mbdSamplingAll,
        max(mariseVaoAll)mariseVaoAll,
        max(msbRegularVaoAll)msbRegularVaoAll,
        max(mbdVaoAll)mbdVaoAll,
        max(mariseBundleAll)mariseBundleAll,
        max(msbRegularBundleAll)msbRegularBundleAll,
        max(mbdBundleAll)mbdBundleAll,
        max(marisePackAll)marisePackAll,
        max(msbRegularPackAll)msbRegularPackAll,
        max(mbdPackAll)mbdPackAll
from 
(SELECT  d.id,t.id territory_id,t.teritory_name territory_name,ba.br_user_user_id,
        sum(case when ab.product_id in(4,23) THEN ab.CONTACT_TARGET else 0 end) mariseSalesTarget,
        sum(case when ab.product_id in(4) THEN ab.CONTACT_TARGET else 0 end) msbRegularTarget,
        sum(case when ab.product_id in(23) THEN ab.CONTACT_TARGET else 0 end) mbdSalesTarget,
        
        NVL(sum(case when ab.product_id in(4,23) THEN ab.FREE_SAMPLING else 0 end),0) mariseSamplingAll,
        NVL(sum(case when ab.product_id in(4) THEN ab.FREE_SAMPLING else 0 end),0)msbRegularSamplingAll,
        NVL(sum(case when ab.product_id in(23) THEN ab.FREE_SAMPLING else 0 end),0)mbdSamplingAll,
        
        NVL(sum(case when ab.product_id in(4,23) THEN ab.VAO_SALES_TARGET else 0 end),0) mariseVaoAll,
        NVL(sum(case when ab.product_id in(4) THEN ab.VAO_SALES_TARGET else 0 end),0)msbRegularVaoAll,
        NVL(sum(case when ab.product_id in(23) THEN ab.VAO_SALES_TARGET else 0 end),0)mbdVaoAll,
        
        NVL(sum(case when ab.product_id in(4,23) THEN ab.BUNDLE_SALES_TARGET else 0 end),0) mariseBundleAll,
        NVL(sum(case when ab.product_id in(4) THEN ab.BUNDLE_SALES_TARGET else 0 end),0)msbRegularBundleAll,
        NVL(sum(case when ab.product_id in(23) THEN ab.BUNDLE_SALES_TARGET else 0 end),0) mbdBundleAll,
        
        NVL(sum(case when ab.product_id in(4,23) THEN ab.PACKET_SALES_TARGET else 0 end),0) marisePackAll,
        NVL(sum(case when ab.product_id in(4) THEN ab.PACKET_SALES_TARGET else 0 end),0)msbRegularPackAll,
        NVL(sum(case when ab.product_id in(23) THEN ab.PACKET_SALES_TARGET else 0 end),0) mbdPackAll

FROM    ASSIGN_BRAND ab
JOIN    BRUSER_ATTENDANCE ba 
        ON ba.BR_TEAM_TEAM_ID = ab.BR_TEAM_ID 
        AND ab.TARGET_DATE = ba.ATTENDANCE_DATE 
JOIN    bruser_teritory but 
        ON ba.br_user_user_id = but.BRUSER_ID
        AND ba.attendance_date between but.ed and but.td
JOIN    bruser_roles bur ON ba.br_user_user_id = bur.bruser_user_id
JOIN    TERITORY t 
        ON t.ID = ab.TERITORY_ID 
JOIN    TERITORY d 
        ON t.PARENT_ID = d.ID
WHERE   to_date(TO_CHAR(ba.ATTENDANCE_DATE_TIME, 'dd-mm-yyyy'), 'dd-mm-yyyy') BETWEEN to_date(:fromDate, 'dd-mm-yyyy')  AND to_date(:toDate, 'dd-mm-yyyy')
and     to_date(TO_CHAR(ab.target_date, 'dd-mm-yyyy'), 'dd-mm-yyyy') BETWEEN to_date(:fromDate, 'dd-mm-yyyy')  AND to_date(:toDate, 'dd-mm-yyyy')
and     bur.roles_id = 12
AND     d.ID LIKE '%'||:divisionId ||'%'
AND     t.ID LIKE '%'||:territoryId ||'%'
GROUP   BY d.id,t.id,t.teritory_name,ba.br_user_user_id)
group   by  id,territory_id, territory_name,br_user_user_id
),

activity as
(

select  division_id,
        territory_Id,
        territory_Name,
        tmrID,
        Max(teamCount)teamCount,
        Max(tmrActiveCount) tmrActiveCount,
        Max(mbdActivity) mbdActivity,
        Max(total_marise_activity) totalMariseActivity,
        Max(msbRegularActivity) msbRegularActivity,
        Max(mbdSampling)mbdSampling,
        Max(mariseTotalSampling)mariseTotalSampling,
        Max(msbRegularSampling)msbRegularSampling,
        Max(mbdVao)mbdVao,
        Max(mariseTotalVao)mariseTotalVao,
        Max(msbRegularVao)msbRegularVao,
        Max(mbdBundle)mbdBundle,
        Max(mariseTotalBundle)mariseTotalBundle,
        Max(msbRegularBundle)msbRegularBundle,
        Max(mbdPacket)mbdPacket,
        Max(mariseTotalPacket)mariseTotalPacket,
        Max(msbRegularPacket)msbRegularPacket,
        Max(visitedOutlet) visitedOutlet
from 
(select  vter.division_id,vter.teritory_id  as territory_Id,
        vter.teritory_name territory_Name,
        bract.br_user_id tmrID,
        count(distinct bract.BR_TEAM_TEAM_ID) teamCount,
        count(distinct bract.BR_user_ID) tmrActiveCount,
        sum(case
            when (bract.contact_module is not null and
            (bract.contact_module = 'MBD_REGULAR' or bract.contact_module = 'MBD_MAGIC'))
            OR bract.offered_brand in (22,23) 
        then 1 else 0 end)    mbdActivity,
        sum(case when (bract.contact_module is not null 
            and bract.contact_module IN ('MARISE','MBD_REGULAR','MBD_MAGIC'))
            or bract.offered_brand in (4,5,22,23) 
        then 1 else 0 end) total_marise_activity,
        sum(case
        when (bract.contact_module is not null 
            and bract.contact_module = 'MARISE') then 1
        else 0 end) msbRegularActivity,
            sum(CASE WHEN bract.OFFERED_BRAND IN (22,23) and bract.SAMPLING_NO > 0 then 1 ELSE 0 END)  mbdSampling,
            sum(case when bract.OFFERED_BRAND in (4, 5,22,23) and bract.SAMPLING_NO > 0 then 1 ELSE 0 END) MariseTotalSampling,
            sum(CASE WHEN bract.OFFERED_BRAND IN (4,5) and bract.SAMPLING_NO > 0 then 1 ELSE 0 END) msbRegularSampling,
            
            sum(CASE WHEN bract.VAO_SALES_BRAND IN (22,23) and bract.VAO_SALES_PACK > 0 then 1 ELSE 0 END)  mbdVao,
            sum(case when bract.VAO_SALES_BRAND in (4, 5,22,23) and bract.VAO_SALES_PACK > 0 then 1 ELSE 0 END) MariseTotalVao,
            sum(CASE WHEN bract.VAO_SALES_BRAND IN (4,5) and bract.VAO_SALES_PACK > 0 then 1 ELSE 0 END) msbRegularVao,
            
            sum(CASE WHEN bract.BUNDLE_PRODUCT_ID IN (22,23) and bract.BUNDLE_PRODUCT_QTY > 0 then 1 ELSE 0 END)  mbdBundle,
            sum(case when bract.BUNDLE_PRODUCT_ID in (4, 5,22,23) and bract.BUNDLE_PRODUCT_QTY > 0 then 1 ELSE 0 END) mariseTotalBundle,
            sum(CASE WHEN bract.BUNDLE_PRODUCT_ID IN (4,5) and bract.BUNDLE_PRODUCT_QTY > 0 then 1 ELSE 0 END) msbRegularBundle,
            
            sum(CASE WHEN bract.PACKET_SALES_BRAND IN (22,23) and bract.SALES_PACK_QTY > 0 then 1 ELSE 0 END)  mbdPacket,
            sum(case when bract.PACKET_SALES_BRAND in (4, 5,22,23) and bract.SALES_PACK_QTY > 0 then 1 ELSE 0 END) MariseTotalPacket,
            sum(CASE WHEN bract.PACKET_SALES_BRAND IN (4,5) and bract.SALES_PACK_QTY > 0 then 1 ELSE 0 END) msbRegularPacket,
            COUNT(DISTINCT bract.OUTLET_ID) visitedOutlet
            
            FROM v_teritory_all vter 
            JOIN (SELECT  * from (SELECT  * FROM BRACTIVITY UNION  SELECT * FROM BRACTIVITY_OLD) 
            WHERE to_date(TO_CHAR(target_date, 'dd-mm-yyyy'), 'dd-mm-yyyy') BETWEEN to_date(:fromDate, 'dd-mm-yyyy') AND to_date(:toDate, 'dd-mm-yyyy')
            ) bract on (bract.route_id = vter.route_id)
             WHERE vter.teritory_id LIKE '%' || :territoryId || '%' 
             AND vter.DIVISION_ID LIKE '%' || :divisionId || '%'
             group BY vter.division_id,vter.teritory_id, vter.teritory_name,bract.br_user_id)
Group       by division_id,territory_Id,territory_Name,tmrID
),
gift as
(
SELECT  vta.teritory_id territory_id,
        BR_USER_USER_ID USER_ID,
        count(DISTINCT bg.CONSUMER_ID) giftCnt 
FROM    BRGIFT bg 
JOIN    bractivity ba
        ON bg.BR_USER_USER_ID = ba.br_user_id
JOIN    v_teritory_all vta
        ON ba.route_id = vta.route_id
WHERE   bg.GIFT_ITEM_ID IN (11,14) AND GIFT_QUANTITY > 0 AND to_date(TO_CHAR(bg.ADD_DATE_TIME,'dd-mm-yy'),'dd-mm-yy')
        between to_date(:fromDate,'dd-mm-yyyy') and to_date(:toDate,'dd-mm-yyyy')
GROUP   BY vta.teritory_id,BR_USER_USER_ID
)
select  p.division_id,
        p.division_name,
        p.territory_id,
        p.territory_name,
        p.tmrId,
        p.tmrName,
        NVL(Max(mariseSalesTarget),0) mariseConTarget,
        NVL(Max(msbRegularTarget),0) msbRegularTarget,
        NVL(Max(mbdSalesTarget),0) mbdSalesTarget,
        NVL(Max(mariseSamplingAll),0) mariseFreeAllotment,
        NVL(Max(msbRegularSamplingAll),0) msbRegularSamplingAll,
        NVL(Max(mbdSamplingAll),0) mbdSamplingAll,
        NVL(Max(mariseVaoAll),0) mariseVaoTarget,
        NVL(Max(msbRegularVaoAll),0) msbRegularVaoAll,
        NVL(Max(mbdVaoAll),0) mbdVaoAll,
        NVL(Max(mariseBundleAll),0) mariseBundleTarget,
        NVL(Max(msbRegularBundleAll),0) msbRegularBundleAll,
        NVL(Max(mbdBundleAll),0) mbdBundleAll,
        NVL(Max(marisePackAll),0) marisePacketTarget,
        NVL(Max(msbRegularPackAll),0) msbRegularPackAll,
        NVL(Max(mbdPackAll),0) mbdPackAll,
        NVL(Max(teamCount),0) teamCount,
        NVL(Max(mbdActivity),0) mbdActivity,
        NVL(Max(totalMariseActivity),0) mariseConContacted,
        NVL(Max(msbRegularActivity),0) msbRegularActivity,
        NVL(Max(mbdSampling),0) mbdSampling,
        NVL(Max(mariseTotalSampling),0) mariseFreeUsed,
        NVL(Max(msbRegularSampling),0) msbRegularSampling,
        NVL(Max(mbdVao),0) mbdVao,
        NVL(Max(mariseTotalVao),0) mariseVaoSales,
        NVL(Max(msbRegularVao),0)msbRegularVao,
        NVL(Max(mbdBundle),0) mbdBundle,
        NVL(Max(mariseTotalBundle),0) mariseBundleSales,
        NVL(Max(msbRegularBundle),0) msbRegularBundle,
        NVL(Max(mbdPacket),0) mbdPacket,
        NVL(Max(mariseTotalPacket),0) marisePacketSales,
        NVL(Max(msbRegularPacket),0) msbRegularPacket,
        NVL(Max(visitedOutlet),0) visitedOutlet,
        NVL(Max(giftCnt),0) matchGiftRetailer
        
from    present p
JOIN    target t
        ON p.territory_id=t.territory_id
Left    JOIN activity a
        ON p.territory_id=a.territory_id
Left    JOIN gift g
        ON p.territory_id = g.territory_id
group   by p.division_id,p.division_name,p.territory_id,p.territory_name,p.tmrId,tmrName
Order   by p.tmrId
