select  bac.division_id divisionId,
        bac.division_name divisionName,
        bac.teritory_id teritoryId,
        bac.teritory_name teritoryName,
        bac.route_name routeName,
        bc.customer_name consumerName,
        bc.customer_address consumerAddress,
        bcon.contact_number contactNumber,
        p.product_name reClaimBrand,
        crs.added_date reClaimDate,
        bac.target_date lastConDate,
        bu.user_name tmrId,
        brep.name tmrName,
        crs.RETENTION_STATUS verificationStatus,
        crs.role verifiedBy,
        crs.CHECKED_DATE verificationDate
        
From 
(SELECT
        added_date,
        CHECKED_DATE,
        RETENTION_STATUS,
        CHECKED_BY_BR_USER,
        CHECKED_BY_USER,
        BR_ACTIVITY_CONSUMER_ID,
        role,
        product_id
FROM
(
SELECT
        crcc.*,
        dsl.sl,
        ROW_NUMBER() OVER(PARTITION BY crcc.br_activity_consumer_id ORDER BY crcc.br_activity_consumer_id, dsl.sl) rnk
FROM
(
(
select
        
        to_char(cre.added_date,'dd-MON-yy')added_date,
        NVL(to_char (crcc.CHECKED_DATE,'dd-MON-YY'),'N/A')CHECKED_DATE,
        NVL(crcc.RETENTION_STATUS,'Not_Found')RETENTION_STATUS,
        NVL(to_char(crcc.CHECKED_BY_BR_USER),'N/A')CHECKED_BY_BR_USER,
        NVL(to_char(crcc.CHECKED_BY_USER),'N/A')CHECKED_BY_USER,
        cre.BR_ACTIVITY_CONSUMER_ID,
        NVL(ro.role,'N/A') role,
        cre.product_id
from    apptm.consumer_retention cre
LEFT    JOIN apptm.consumer_retention_cross_check crcc
        ON cre.BR_ACTIVITY_CONSUMER_ID=crcc.BR_ACTIVITY_CONSUMER_ID
LEFT    JOIN apptm.bruser_roles brl ON crcc.CHECKED_BY_BR_USER=brl.bruser_user_id
LEFT    JOIN apptm.role ro ON ro.id=brl.roles_id
where   cre.added_date between :fromDate and :toDate
)
union all
(
select
        to_char(cre.added_date,'dd-MON-yy')added_date,
        NVL(to_char (crcc.CHECKED_DATE,'dd-MON-YY'),'N/A') CHECKED_DATE,
        NVL(crcc.RETENTION_STATUS,'Not_Found') RETENTION_STATUS,
        NVL(to_char(crcc.CHECKED_BY_BR_USER),'N/A') CHECKED_BY_BR_USER,
        NVL(to_char(crcc.CHECKED_BY_USER),'N/A') CHECKED_BY_USER,
        cre.BR_ACTIVITY_CONSUMER_ID,
        NVL(r.role,'N/A') role,
        cre.product_id
FROM    apptm.consumer_retention cre
LEFT    JOIN apptm.consumer_retention_cross_check crcc ON cre.BR_ACTIVITY_CONSUMER_ID=crcc.BR_ACTIVITY_CONSUMER_ID
LEFT    JOIN apptm.users_roles ur ON crcc.CHECKED_BY_USER=ur.users_user_id
LEFT    JOIN apptm.role r ON r.id=ur.roles_id
where   cre.added_date between :fromDate and :toDate
)
) crcc,
(
SELECT  1 sl, 'DIVISION_MANAGER' role FROM DUAL
UNION   ALL
SELECT  2 sl, 'TERRITORY_MANAGER' role FROM DUAL
UNION   ALL
SELECT  3 sl, 'TMS' role FROM DUAL
UNION   ALL
SELECT  4 sl, 'N/A' role FROM DUAL
) dsl
WHERE   crcc.role = dsl.role
)

where   rnk = 1
and     RETENTION_STATUS like '' || :retentionStatus || '%'
) crs 
JOIN
(
Select  
        division_id,
        division_name,
        teritory_id,
        teritory_name,
        route_id,
        route_name,
        br_user_id,
        br_activity_consumer_id,
        target_date
From 
    (SELECT  
        v.division_id,
        v.division_name,
        v.teritory_id,
        v.teritory_name,
        v.route_id,
        v.route_name,
        cr.br_user_user_id br_user_id,
        ba.br_activity_consumer_id,
        to_char(ba.target_date,'dd-MON-yy') target_date,
        dense_rank() over( PARTITION by ba.br_activity_consumer_id order by ba.add_date_time desc) rank
FROM    (select * from apptm.bractivity b  union select * from apptm.bractivity_old bo) ba
JOIN    (select br_activity_consumer_id,br_user_user_id,product_id from apptm.consumer_retention cr where cr.added_date between :fromDate and :toDate) cr
        on cr.br_activity_consumer_id=ba.br_activity_consumer_id
AND     ba.offered_brand=(CASE
            WHEN cr.product_id = 1 THEN 2
            WHEN cr.product_id = 11 THEN 12
            WHEN cr.product_id = 13 THEN 14
            WHEN cr.product_id = 4 THEN 5
            WHEN cr.product_id = 22 THEN 23
            WHEN cr.product_id = 16 THEN 17
            WHEN cr.product_id = 18 THEN 19
            WHEN cr.product_id = 20 THEN 21
            ELSE cr.product_id
        END)
JOIN    apptm.v_teritory_all v ON ba.route_id=v.route_id
                )
            where   rank=1
) bac
        ON crs.br_activity_consumer_id=bac.br_activity_consumer_id
JOIN    apptm.bractivity_consumer bc ON crs.BR_ACTIVITY_CONSUMER_ID=bc.id
JOIN    apptm.bractivity_contact bcon ON bc.br_activity_contact_id=bcon.id
JOIN    apptm.bruser bu ON bu.user_id=bac.br_user_id
JOIN    apptm.brand_representative brep ON bu.user_id=brep.br_user_user_id
JOIN    apptm.product p ON p.product_id=crs.product_id
where   bac.division_id like '%' || :divisionId || '%'
AND     bac.teritory_id like '%' || :teritoryId || '%'     
order   by bac.division_id ,bac.teritory_id ,crs.CHECKED_DATE ,bac.target_date ,bu.user_name