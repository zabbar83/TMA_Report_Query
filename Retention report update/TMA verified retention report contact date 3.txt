select  bac.division_id divisionId,
        bac.division_name divisionName,
        bac.teritory_id teritoryId,
        bac.teritory_name teritoryName,
        bac.route_name routeName,
        bc.customer_name consumerName,
        bc.customer_address consumerAddress,
        bcon.contact_number contactNumber,
        p.product_name reClaimBrand,
        to_char(crs.added_date,'dd-MON-yy') reClaimDate,
        to_char(bac.target_date,'dd-MON-yy') lastConDate,
        bu.user_name tmrId,
        brep.name tmrName,
        crs.RETENTION_STATUS verificationStatus,
        crs.role verifiedBy,
        to_char(crs.CHECKED_DATE,'dd-MON-yy') verificationDate,
        ' ' status,
        ' ' signature,
        ' ' verifiedBy2,
        crs.id crossCheckId
        
From 
(SELECT
        ID,
        added_date,
        CHECKED_DATE,
        RETENTION_STATUS,
        CHECKED_BY_BR_USER,
        CHECKED_BY_USER,
        BR_ACTIVITY_CONSUMER_ID,
        role,
        product_id
FROM
(
SELECT
        crcc.*,
        dsl.sl,
        ROW_NUMBER() OVER(PARTITION BY crcc.br_activity_consumer_id ORDER BY crcc.br_activity_consumer_id, dsl.sl) rnk
FROM
(
(
select
        crcc.ID,
        cre.added_date,
        crcc.CHECKED_DATE,
        crcc.RETENTION_STATUS,
        crcc.CHECKED_BY_BR_USER,
        crcc.CHECKED_BY_USER,
        crcc.BR_ACTIVITY_CONSUMER_ID,
        ro.role,
        cre.product_id
from    (select * from apptm.bractivity b  union select * from apptm.bractivity_old bo) ba
JOIN    apptm.consumer_retention cre ON ba.BR_ACTIVITY_CONSUMER_ID=cre.BR_ACTIVITY_CONSUMER_ID
JOIN    apptm.consumer_retention_cross_check crcc ON cre.BR_ACTIVITY_CONSUMER_ID=crcc.BR_ACTIVITY_CONSUMER_ID
JOIN    apptm.bruser br ON crcc.CHECKED_BY_BR_USER=br.user_id
JOIN    apptm.bruser_roles brl ON br.user_id=brl.bruser_user_id
JOIN    apptm.role ro ON ro.id=brl.roles_id
where   ba.target_date between :fromDate and :toDate
AND     ba.offered_brand=(CASE
            WHEN cre.product_id = 1 THEN 2
            WHEN cre.product_id = 11 THEN 12
            WHEN cre.product_id = 13 THEN 14
            WHEN cre.product_id = 4 THEN 5
            WHEN cre.product_id = 22 THEN 23
            WHEN cre.product_id = 16 THEN 17
            WHEN cre.product_id = 18 THEN 19
            WHEN cre.product_id = 20 THEN 21
            ELSE cre.product_id
        END)
)
union all
(
select
        crcc.ID,
        cre.added_date,
        crcc.CHECKED_DATE,
        crcc.RETENTION_STATUS,
        crcc.CHECKED_BY_BR_USER,
        crcc.CHECKED_BY_USER,
        crcc.BR_ACTIVITY_CONSUMER_ID,
        r.role role,
        cre.product_id
FROM    (select * from apptm.bractivity b  union select * from apptm.bractivity_old bo) ba
JOIN    apptm.consumer_retention cre ON ba.BR_ACTIVITY_CONSUMER_ID=cre.BR_ACTIVITY_CONSUMER_ID
JOIN    apptm.consumer_retention_cross_check crcc ON cre.BR_ACTIVITY_CONSUMER_ID=crcc.BR_ACTIVITY_CONSUMER_ID
JOIN    apptm.users us ON crcc.CHECKED_BY_USER=us.user_id
JOIN    apptm.users_roles ur ON us.user_id=ur.users_user_id
JOIN    apptm.role r ON r.id=ur.roles_id
where   ba.target_date between :fromDate and :toDate
AND     ba.offered_brand=(CASE
            WHEN cre.product_id = 1 THEN 2
            WHEN cre.product_id = 11 THEN 12
            WHEN cre.product_id = 13 THEN 14
            WHEN cre.product_id = 4 THEN 5
            WHEN cre.product_id = 22 THEN 23
            WHEN cre.product_id = 16 THEN 17
            WHEN cre.product_id = 18 THEN 19
            WHEN cre.product_id = 20 THEN 21
            ELSE cre.product_id
        END)
)
) crcc,
(
SELECT  1 sl, 'DIVISION_MANAGER' role FROM DUAL
UNION   ALL
SELECT  2 sl, 'TERRITORY_MANAGER' role FROM DUAL
UNION   ALL
SELECT  3 sl, 'TMS' role FROM DUAL
) dsl
WHERE   crcc.role = dsl.role
)

where   rnk = 1
AND     RETENTION_STATUS ='Retained' 
) crs 
JOIN
(
Select  
        division_id,
        division_name,
        teritory_id,
        teritory_name,
        route_id,
        route_name,
        br_user_id,
        br_activity_consumer_id,
        target_date
From 
    (SELECT  
        v.division_id,
        v.division_name,
        v.teritory_id,
        v.teritory_name,
        v.route_id,
        v.route_name,
        cr.br_user_user_id br_user_id,
        ba.br_activity_consumer_id,
        ba.target_date target_date,
        dense_rank() over( PARTITION by ba.br_activity_consumer_id order by ba.add_date_time desc) rank
FROM    (select * from apptm.bractivity b  union select * from apptm.bractivity_old bo) ba
JOIN    apptm.consumer_retention cr
        on cr.br_activity_consumer_id=ba.br_activity_consumer_id
AND     ba.target_date between :fromDate and :toDate
AND     ba.offered_brand=(CASE
            WHEN cr.product_id = 1 THEN 2
            WHEN cr.product_id = 11 THEN 12
            WHEN cr.product_id = 13 THEN 14
            WHEN cr.product_id = 4 THEN 5
            WHEN cr.product_id = 22 THEN 23
            WHEN cr.product_id = 16 THEN 17
            WHEN cr.product_id = 18 THEN 19
            WHEN cr.product_id = 20 THEN 21
            ELSE cr.product_id
        END)
JOIN    apptm.v_teritory_all v ON ba.route_id=v.route_id
where   v.teritory_id IN (:teritoryId)
                )
        where   rank=1
        )bac
        ON crs.br_activity_consumer_id=bac.br_activity_consumer_id
JOIN    apptm.bractivity_consumer bc ON crs.BR_ACTIVITY_CONSUMER_ID=bc.id
JOIN    apptm.bractivity_contact bcon ON bc.br_activity_contact_id=bcon.id
JOIN    apptm.bruser bu ON bu.user_id=bac.br_user_id
JOIN    apptm.brand_representative brep ON bu.user_id=brep.br_user_user_id
JOIN    apptm.product p ON p.product_id=crs.product_id
LEFT    JOIN apptm.CROSS_CHECK_VERIFY_BY_SALES ccvs ON crs.id=ccvs.CON_RET_CROSS_CHE_ID
where   ccvs.CON_RET_CROSS_CHE_ID is null
order   by bac.division_id ,bac.teritory_id ,crs.CHECKED_DATE ,bac.target_date ,bu.user_name